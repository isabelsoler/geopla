(function (cjs, an) {

var p; // shortcut to reference prototypes
var lib={};var ss={};var img={};
lib.ssMetadata = [];


// symbols:



(lib.blackwood = function() {
	this.initialize(img.blackwood);
}).prototype = p = new cjs.Bitmap();
p.nominalBounds = new cjs.Rectangle(0,0,916,806);


(lib.Mapadebits2 = function() {
	this.initialize(img.Mapadebits2);
}).prototype = p = new cjs.Bitmap();
p.nominalBounds = new cjs.Rectangle(0,0,19,19);// helper functions:

function mc_symbol_clone() {
	var clone = this._cloneProps(new this.constructor(this.mode, this.startPosition, this.loop));
	clone.gotoAndStop(this.currentFrame);
	clone.paused = this.paused;
	clone.framerate = this.framerate;
	return clone;
}

function getMCSymbolPrototype(symbol, nominalBounds, frameBounds) {
	var prototype = cjs.extend(symbol, cjs.MovieClip);
	prototype.clone = mc_symbol_clone;
	prototype.nominalBounds = nominalBounds;
	prototype.frameBounds = frameBounds;
	return prototype;
	}


(lib.resalte = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.shape = new cjs.Shape();
	this.shape.graphics.f().s("#FF9900").ss(4,1,1).p("AjskTIHZAAQBFAAAABEIAAGfQAABEhFAAInZAAQhFAAAAhEIAAmfQAAhEBFAAg");

	this.timeline.addTween(cjs.Tween.get(this.shape).wait(1));

}).prototype = getMCSymbolPrototype(lib.resalte, new cjs.Rectangle(-32.5,-29.6,65.2,59.3), null);


(lib.puntoBase1_mc = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.shape = new cjs.Shape();
	this.shape.graphics.f("#9966CC").s().p("AhNBPQghghAAguQAAguAhggQAhggAsAAQAwAAAfAgQAgAgAAAuQAAAtggAiQgfAggwAAQgsAAghggg");

	this.timeline.addTween(cjs.Tween.get(this.shape).wait(1));

}).prototype = getMCSymbolPrototype(lib.puntoBase1_mc, new cjs.Rectangle(-11,-11,22.2,22.2), null);


(lib.punt = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.shape = new cjs.Shape();
	this.shape.graphics.f("#999999").s().p("AhABBQgbgbAAgmQAAglAbgbQAbgbAlAAQAmAAAbAbQAbAbAAAlQAAAmgbAbQgbAbgmAAQglAAgbgbg");

	this.timeline.addTween(cjs.Tween.get(this.shape).wait(1));

}).prototype = getMCSymbolPrototype(lib.punt, new cjs.Rectangle(-9.1,-9.1,18.3,18.3), null);


(lib.goma1_mc = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.shape = new cjs.Shape();
	this.shape.graphics.f().s("#9966CC").ss(6,1,1,3,true).p("AgBFBQhkgSAViHQAHgsAShwQAMhhgTgvQgZhBAFg1QAFg8AtgKQAtgKAVAcQAUAaABA+QAACcABADQAEB5AUB1QANBNgXAkQgVAkgygLg");

	this.timeline.addTween(cjs.Tween.get(this.shape).wait(1));

}).prototype = getMCSymbolPrototype(lib.goma1_mc, new cjs.Rectangle(-11.5,-35.3,23,70.7), null);


(lib.goma_btn = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.shape = new cjs.Shape();
	this.shape.graphics.f().s("#9966CC").ss(6,1,1,3,true).p("AEjFVQh8BHhkijQgig2hRiIQhNhzhAgiQhVgugrg9QgzhFAogzQApg1AwAKQAtAKA5BBQCOCnADADQB0B9CBBsQBUBGAJA7QAIA6g/Akg");
	this.shape.setTransform(-2,1.8);

	this.shape_1 = new cjs.Shape();
	this.shape_1.graphics.f("#FFFFFF").s().p("AlfFgQiRiSAAjOQAAjNCRiSQCSiRDNAAQDOAACSCRQCRCSAADNQAADOiRCSQiSCRjOAAQjNAAiSiRg");

	this.timeline.addTween(cjs.Tween.get({}).to({state:[{t:this.shape_1},{t:this.shape}]}).wait(1));

}).prototype = getMCSymbolPrototype(lib.goma_btn, new cjs.Rectangle(-49.7,-49.7,99.4,99.4), null);


(lib.eliminar_btn = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.shape = new cjs.Shape();
	this.shape.graphics.f().s("#4D555E").ss(0.5,1,1).p("ABwhCQAAAGgFAAIgPAAIAACWQAAANgIAKQgHAJgKAAIiEAAQgLAAgHgJQgIgJAAgNIAAiXIgOAAQgGAAAAgGIAAgJQAAgGAGAAIAwAAIALgaQACgGAHgEQAHgEAGAAIAyAAQAGAAAGAEQAHAEACAGIALAaIAxAAQAFAAAAAGgAAkhRIgIgSIgDgCIgxAAIgDACIgIASgAAzBCQAAAGgFAAIgKAAQgFAAAAgGIAAhaQAAgFAFAAIAKAAQAFAAAAAFgAALBCQAAAGgGAAIgJAAQgFAAAAgGIAAhaQAAgFAFAAIAJAAQAGAAAAAFgABIg8IiOAAIAACWQAAAEACAFQACADABAAICEAAQAAAAADgDQACgFAAgEgAgeBCQAAAGgFAAIgKAAQgBAAgCgCQgCgBAAgDIAAhaQAAgFAFAAIAKAAQAFAAAAAFg");

	this.shape_1 = new cjs.Shape();
	this.shape_1.graphics.f("#4D555E").s().p("AhBB6QgLAAgHgJQgIgJAAgNIAAiXIgOAAQgGAAAAgGIAAgJQAAgGAGAAIAwAAIALgaQACgGAHgEQAHgEAGAAIAyAAQAGAAAGAEQAHAEACAGIALAaIAxAAQAFAAAAAGIAAAJQAAAGgFAAIgPAAIAACWQAAANgIAKQgHAJgKAAgAhGBaQAAAEACAFQABABAAAAQABABAAAAQAAABABAAQAAAAAAAAICEAAIADgDQACgFAAgEIAAiWIiOAAgAgbhjIgIASIBHAAIgIgSIgDgCIgxAAgAAkBIQgFAAAAgGIAAhaQAAgFAFAAIAKAAQAFAAAAAFIAABaQAAAGgFAAgAgEBIQgFAAAAgGIAAhaQAAgFAFAAIAJAAQAGAAAAAFIAABaQAAAGgGAAgAgtBIIgDgCQAAAAgBgBQAAAAgBAAQAAgBAAgBQAAAAAAgBIAAhaQAAgFAFAAIAKAAQAFAAAAAFIAABaQAAAGgFAAg");

	this.shape_2 = new cjs.Shape();
	this.shape_2.graphics.f("#DAE1E7").s().p("Ah7B8Qg0gzAAhJQAAhIA0gzQAzg0BIAAQBJAAAzA0QA0AzAABIQAABJg0AzQgzA0hJAAQhIAAgzg0g");

	this.timeline.addTween(cjs.Tween.get({}).to({state:[{t:this.shape_2},{t:this.shape_1},{t:this.shape}]}).wait(1));

}).prototype = getMCSymbolPrototype(lib.eliminar_btn, new cjs.Rectangle(-17.6,-17.6,35.2,35.2), null);


(lib.dumi = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.shape = new cjs.Shape();
	this.shape.graphics.f("#FFFFFF").s().p("AhRBSQgigiABgwQgBgvAigiQAigiAvABQAwgBAiAiQAhAiAAAvQAAAwghAiQgiAhgwAAQgvAAgighg");

	this.timeline.addTween(cjs.Tween.get(this.shape).wait(1));

}).prototype = getMCSymbolPrototype(lib.dumi, new cjs.Rectangle(-11.5,-11.5,23.1,23.1), null);


(lib.clavo = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.instance = new lib.Mapadebits2();
	this.instance.parent = this;
	this.instance.setTransform(-9.3,-9.5);

	this.timeline.addTween(cjs.Tween.get(this.instance).wait(1));

}).prototype = getMCSymbolPrototype(lib.clavo, new cjs.Rectangle(-9.3,-9.5,19,19), null);


(lib.baseUi_mc = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.shape = new cjs.Shape();
	this.shape.graphics.f("#FFFFFF").s().p("EhHeAFeIAAq7MCO9AAAIAAK7g");
	this.shape.setTransform(0,-35);

	this.timeline.addTween(cjs.Tween.get(this.shape).wait(1));

}).prototype = getMCSymbolPrototype(lib.baseUi_mc, new cjs.Rectangle(-457.5,-70,915,70), null);


(lib.point_mc = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.shape = new cjs.Shape();
	this.shape.graphics.f().s("#FFFFFF").ss(3.5,0,0,3).p("AA7AAQAAAZgRARQgQASgaAAQgYAAgSgSQgQgSAAgYQAAgXAQgTQASgRAYAAQAaAAAQARQARATAAAXg");
	this.shape.setTransform(0,0,1.181,1.181);

	this.base = new lib.puntoBase1_mc();
	this.base.name = "base";
	this.base.parent = this;
	this.base.setTransform(0,0,1.181,1.181);

	this.timeline.addTween(cjs.Tween.get({}).to({state:[{t:this.base},{t:this.shape}]}).wait(1));

}).prototype = getMCSymbolPrototype(lib.point_mc, new cjs.Rectangle(-13,-13.1,26.2,26.2), null);


(lib.btn2 = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.instance = new lib.punt();
	this.instance.parent = this;
	this.instance.setTransform(23.3,19.9,0.566,0.566,0,0,0,0,0.1);

	this.instance_1 = new lib.punt();
	this.instance_1.parent = this;
	this.instance_1.setTransform(0.7,19.9,0.566,0.566,0,0,0,0.1,0.1);

	this.instance_2 = new lib.punt();
	this.instance_2.parent = this;
	this.instance_2.setTransform(-21.9,19.9,0.566,0.566,0,0,0,0,0.1);

	this.instance_3 = new lib.punt();
	this.instance_3.parent = this;
	this.instance_3.setTransform(23.3,-19.9,0.566,0.566,0,0,0,0,0.2);

	this.instance_4 = new lib.punt();
	this.instance_4.parent = this;
	this.instance_4.setTransform(0.7,-19.9,0.566,0.566,0,0,0,0.1,0.2);

	this.instance_5 = new lib.punt();
	this.instance_5.parent = this;
	this.instance_5.setTransform(-21.9,-19.9,0.566,0.566,0,0,0,0,0.2);

	this.instance_6 = new lib.punt();
	this.instance_6.parent = this;
	this.instance_6.setTransform(12,0,0.566,0.566,0,0,0,0.1,0);

	this.instance_7 = new lib.punt();
	this.instance_7.parent = this;
	this.instance_7.setTransform(-10.6,0,0.566,0.566,0,0,0,0.1,0);

	this.shape = new cjs.Shape();
	this.shape.graphics.f("#323232").s().p("AkUFCQhQAAAAhQIAAnjQAAhQBQAAIIpAAQBQAAAABQIAAHjQAABQhQAAg");

	this.timeline.addTween(cjs.Tween.get({}).to({state:[{t:this.shape},{t:this.instance_7},{t:this.instance_6},{t:this.instance_5},{t:this.instance_4},{t:this.instance_3},{t:this.instance_2},{t:this.instance_1},{t:this.instance}]}).wait(1));

}).prototype = getMCSymbolPrototype(lib.btn2, new cjs.Rectangle(-35.6,-32.2,71.4,64.5), null);


(lib.btn1 = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// Capa_1
	this.instance = new lib.punt();
	this.instance.parent = this;
	this.instance.setTransform(22.5,19.9,0.566,0.566,0,0,0,0,0.1);

	this.instance_1 = new lib.punt();
	this.instance_1.parent = this;
	this.instance_1.setTransform(-0.1,19.9,0.566,0.566,0,0,0,0.1,0.1);

	this.instance_2 = new lib.punt();
	this.instance_2.parent = this;
	this.instance_2.setTransform(-22.7,19.9,0.566,0.566,0,0,0,0.1,0.1);

	this.instance_3 = new lib.punt();
	this.instance_3.parent = this;
	this.instance_3.setTransform(22.5,-19.9,0.566,0.566,0,0,0,0,0.2);

	this.instance_4 = new lib.punt();
	this.instance_4.parent = this;
	this.instance_4.setTransform(-0.1,-19.9,0.566,0.566,0,0,0,0.1,0.2);

	this.instance_5 = new lib.punt();
	this.instance_5.parent = this;
	this.instance_5.setTransform(-22.7,-19.9,0.566,0.566,0,0,0,0.1,0.2);

	this.instance_6 = new lib.punt();
	this.instance_6.parent = this;
	this.instance_6.setTransform(22.5,0,0.566,0.566);

	this.instance_7 = new lib.punt();
	this.instance_7.parent = this;
	this.instance_7.setTransform(-0.1,0,0.566,0.566,0,0,0,0.1,0);

	this.instance_8 = new lib.punt();
	this.instance_8.parent = this;
	this.instance_8.setTransform(-22.7,0,0.566,0.566,0,0,0,0.1,0);

	this.shape = new cjs.Shape();
	this.shape.graphics.f("#323232").s().p("AkUFCQhQAAAAhQIAAnjQAAhQBQAAIIpAAQBQAAAABQIAAHjQAABQhQAAg");

	this.timeline.addTween(cjs.Tween.get({}).to({state:[{t:this.shape},{t:this.instance_8},{t:this.instance_7},{t:this.instance_6},{t:this.instance_5},{t:this.instance_4},{t:this.instance_3},{t:this.instance_2},{t:this.instance_1},{t:this.instance}]}).wait(1));

}).prototype = getMCSymbolPrototype(lib.btn1, new cjs.Rectangle(-35.6,-32.2,71.4,64.5), null);


// stage content:
(lib.index = function(mode,startPosition,loop) {
	this.initialize(mode,startPosition,loop,{});

	// timeline functions:
	this.frame_1 = function() {
		this.stop();
		
		var _this = this;
		
		var canvas = _this.getStage().canvas;
		var container = canvas.parentElement.parentElement;
		
		var modoAplica;
		
		var escala = 1;
		var w;
		
		function update(event){
			escala = Math.round(window.devicePixelRatio*100)/100;	
			w = 914*escala;	
			escala = 914/w;
		}
		
		_this.addEventListener("tick", update);
		
		try{
			modoAplica = this.getStage().getVariable;
		}catch{
			modoAplica = false;
		}
		
		var gridDist = 100;
		var margen = gridDist/2;
		var gridOfset = 0;
		
		var escenaH = 766 - margen;
		var escenaW = 914 - margen;
		
		var filas = Math.round(escenaH/gridDist);
		var columnas = Math.round(escenaW/gridDist);
		
		var clavos_arr = [];
		
		function situarClavos(){
			for(var i=0; i<clavos_arr.length; i++){
				_this.removeChild(clavos_arr[i]);
			}
			clavos_arr = [];
			for(var i=0; i<filas; i++){
				for(var j=0; j<columnas; j++){
					var clavo = new lib.clavo();
					_this.addChild(clavo);
					
					clavos_arr.push(clavo);
					
					
					clavo.y = margen + i*gridDist;
					if(i%2 == 0){
						clavo.x = margen + j*gridDist;
					}else{
						clavo.x = margen + j*gridDist + gridOfset;
					}
				}
			}
			for(var i=0; i<puntos_arr.length; i++){
				snapPunto(puntos_arr[i], puntos_arr[i].x-5*selecGrid, puntos_arr[i].y);
				_this.setChildIndex(puntos_arr[i], _this.getNumChildren()-1);
			}
			dibujarLineas();
			calcularArea();
		}
		
		
		
		function rollOver(event){
			event.currentTarget.cursor = "pointer";
		}
		
		function copiarArray(arr){
			var newArr = [];
			for(var i=0; i<arr.length; i++){
				newArr.push(arr[i]);
			}
			return newArr;
		}
		
		//Limitar un valor entre un mínim i un màxim
		function clamp(val, min, max){
			var miMax = max;
			var miMin = min;
			if(max<min){
				miMax = min;
				miMin = max;
			}
		    return Math.max(miMin, Math.min(miMax, val));
		}
		
		
		function redondear(str, decimales){	
			if(!isNaN(Number(str))){
				var dec = Math.pow(10, decimales);
				str = Math.round(Number(str)*dec)/dec;
			}	
			return str;
		}
		
		function numToStr(num){
			var str;
			if(modoAplica){
				str = _this.getStage().toLocaleStr(num);
			}else{
				str = String(num).replace(".", ",");
			}
			return str;
		}
		
		
		function iniciarGraf(mc){
			mc.graf.clear();
			mc.graf.beginStroke("#9255CF");
			mc.graf.setStrokeStyle(6, "round");	
		}
		
		function crearClipDibujo(){
			var lines_mc = new createjs.MovieClip();
			_this.addChild(lines_mc);
			lines_mc.graf = new createjs.Graphics();
			lines_mc.shape = new createjs.Shape(lines_mc.graf);
			lines_mc.shape.x = 0;
			lines_mc.shape.y = 0;
			lines_mc.addChild(lines_mc.shape);
			return lines_mc;
		}
		
		//Obtener función de una recta a partir de dos puntos
		function getLinea(p1, p2){
		
			var x1 = p1.x;
			var y1 = p1.y;
			var x2 = p2.x;
			var y2 = p2.y;
			
			var m = (y2 - y1)/(x2 - x1);
			var b = y1 - m * x1;
			var v = false;//Indicar si és una línia vertical
			
			var tipo = "D";
		
			if(Math.round((y2-y1)*1000)/1000 == 0){ //Horizontal
				m = 0;
				b = y1;
				tipo = "H";
			}
			
			if(Math.round((x2-x1)*1000)/1000 == 0){ //Vertical
				m = 0;
				b = x1;
				v = true;
				tipo = "V";
			}
		
			//Guardar línea y límites del segmento
			if(x2 < x1){
				var aux = x1;
				x1 = x2;
				x2 = aux;
			}
			if(y2 < y1){
				var aux = y1;
				y1 = y2;
				y2 = aux;
			}
			return {m,b,tipo, x1, y1, x2, y2, p1, p2};
		}
		//Obtener recta perpendicular a una recta que pasa por un punto
		function getLinePerp(line, px, py){
			var m = -1/line.m;
		
			var b = py - m * px;
			
			var tipo = "D";
			
			if(line.m == 0 && !line.v){//Si es una horizontal, la resultante es una vertical en px
				m = 0;
				b = px;
				tipo = "V";
			}
			
			else if(line.v){//Si és una linea vertical, la resultante es una horizontal igual a cx
				m = 0;
				b = px;
				tipo = "H";
			}
			
			
			return {m,b,tipo};
		}
		
		//Punto de corte entre dos rectas
		function getCorteLineas(line1, line2){
			var corte = false;
			var cx = 0;
			var cy = 0;
			
			if(line1.p1 != line2.p2 && line1.p2 != line2.p1 ){
				//if((line1.m != 0 || line2.m != 0) && line1.m != line2.m){
					corte = true;
					var cx = (line1.b - line2.b)/(line2.m - line1.m);
					var cy = line1.m * cx + line1.b;
		
					if(line1.tipo == "V"){
						cx = line1.b;
						cy = line2.m * cx + line2.b;
					}else if(line2.tipo == "V"){
						cx = line2.b;
						cy = line1.m * cx + line1.b;
					}
		
					if(line1.tipo == "D" || line2.tipo == "D"){
						//Comprobar que el punto de corte está dentro de los límites de los 2 segmentos
						if(cx < line1.x1 || cx > line1.x2){
							corte = false;
						}
						if(cy < line1.y1 || cy > line1.y2){
							corte = false;
						}
						if(cx < line2.x1 || cx > line2.x2){
							corte = false;
						}
						if(cy < line2.y1 || cy > line2.y2){
							corte = false;
						}
					}else{
						if(line1.tipo == line2.tipo){
							corte = false;
						}else{
							if(line1.tipo == "H"){
								if(cx < line1.x1 || cx > line1.x2){
									corte = false;
								}
								if(cy < line2.y1 || cy > line2.y2){
									corte = false;
								}
							}
							else if(line2.tipo == "H"){
								if(cx < line2.x1 || cx > line2.x2){
									corte = false;
								}
								if(cy < line1.y1 || cy > line1.y2){
									corte = false;
								}
							}
						}
				//	}
				}
			}
			
			return {cx, cy, corte, line1, line2};
		}
		var btn = this.btn;
		
		var funciones_arr = [];
		var graf_arr = [];
		
		var point_mc = this.point_mc;
		var eliminar_btn = this.eliminar_btn;
		
		var goma1_mc = this.goma1_mc;
		var goma_btn = this.goma_btn;
		
		var p1 = this.p1;
		var p2 = this.p2;
		
		var puntos_arr = [];
		
		var ref = this.ref;
		
		var gomaPuntos_arr = [];
		var gomaClip_arr = [];
		
		var gomaGraf_arr = [];
		var gomaGrafArea_arr = [];
		
		var gomaSel;
		
		
		
		function dibujarLineas(){
			for(var i=0; i<gomaGraf_arr.length; i++){
				_this.removeChild(gomaGraf_arr[i]);
				_this.removeChild(gomaGrafArea_arr[i]);
			}
			gomaGraf_arr = [];
			gomaGrafArea_arr = [];
			for(var i=0; i<puntos_arr.length; i++){
				var graf = crearClipDibujo();
				gomaGraf_arr.push(graf);
				graf.graf.clear();
				graf.graf.beginStroke("#9255CF");
				graf.graf.setStrokeStyle(8, "round");	
				
				var grafA = crearClipDibujo();
				gomaGrafArea_arr.push(grafA);
				grafA.graf.clear();
				grafA.graf.beginStroke("#9255CF");
				grafA.graf.setStrokeStyle(40, "round");	
				
				var p1 = puntos_arr[i];
				graf.i1 = i;
				
				if(i<puntos_arr.length-1){
					var p2 = puntos_arr[i+1];
					graf.i2 = i+1;
				}else{
					var p2 = puntos_arr[0];
					graf.i2 = 0;
				}
				
				graf.graf.moveTo(p1.x, p1.y);
				graf.graf.lineTo(p2.x, p2.y);	
				
				grafA.graf.moveTo(p1.x, p1.y);
				grafA.graf.lineTo(p2.x, p2.y);
				
				graf.addEventListener("mousedown", linePress);
				graf.addEventListener("pressmove", drag);	
				graf.addEventListener("pressup", release);
				
				graf.hitArea = grafA.shape;
				grafA.visible = false;
			}
			for(var i=0; i<puntos_arr.length; i++){
				puntos_arr[i].i1 = i;
				puntos_arr[i].i2 = i+1;
				if(i+1 == puntos_arr.length) puntos_arr[i].i2 = 0;
				_this.setChildIndex(puntos_arr[i], _this.getNumChildren()-1);
			}
		}
		
		function crearPunto(){	
			var p = new lib.point_mc();
			_this.addChild(p);
			
			p.addEventListener("mousedown", press);
			p.addEventListener("pressmove", drag);
			p.addEventListener("pressup", release);
			return p;
		}
		
		function linePress(event){
			var mc = event.currentTarget;
			var p = crearPunto();
			
			p.x = _this.getStage().mouseX*escala;	
			p.y = _this.getStage().mouseY*escala;	
			
			dragP = p;
			
			puntos_arr.splice(mc.i2, 0, p);
				
			for(var i=0; i<puntos_arr.length; i++){
				puntos_arr[i].i1 = i;
				puntos_arr[i].i2 = i+1;
				if(i+1 == puntos_arr.length) puntos_arr[i].i2 = 0;
			}
			dragP.movido = true;
			dragP.nuevo = true;
			dibujarLineas();
		}
		
		function pressDefault(){
			eliminar_btn.visible = false;
		}
		
		function press(event){
			pressDefault();
			var mc = event.currentTarget;	
			var offset = mc.globalToLocal(_this.getStage().mouseX*escala, _this.getStage().mouseY*escala);
			mc.offsetX = offset.x * mc.scaleX *escala;	
			mc.offsetY = offset.y * mc.scaleY*escala;		
			dragP = mc;
			dragP.movido = false;
			dragP.nuevo = false;
		}
		
		function drag(event){
			var mc = event.currentTarget;
			dragP.movido = true;
			dragP.x = _this.getStage().mouseX*escala;	
			dragP.y = _this.getStage().mouseY*escala;		
			dibujarLineas();
		}
		
		function snapPunto(mc, cx, cy){
			if(!cx){
				cx = mc.x;
				cy = mc.y;
			}
		
			cy = clamp(cy, 0, escenaH-gridDist);	
			
			var snapX = Math.round((cy-margen)/gridDist);
			if(snapX%2 == 0){
				mc.x = margen + Math.round((cx-margen)/gridDist)*gridDist;	
			}else{
				mc.x = margen + Math.round((cx-margen-gridOfset)/gridDist)*gridDist + gridOfset;	
			}
			mc.y = margen + Math.round((cy-margen)/gridDist)*gridDist;	
			
		}
		
		function release(event){	
			var mc = event.currentTarget;
			if(!dragP.movido){
				if(puntos_arr.length >2){
					eliminar_btn.visible = true;
					_this.setChildIndex(eliminar_btn, _this.getNumChildren()-1);
					eliminar_btn.x = dragP.x;
					eliminar_btn.y = dragP.y -40;
				}
			}
			snapPunto(dragP, _this.getStage().mouseX*escala, _this.getStage().mouseY*escala);
			dibujarLineas();
		
			for(var i=0; i<puntos_arr.length; i++){
				if(puntos_arr[i] == dragP){
					var i1 = i-1;
					var i2 = i+1;
					if(i1 <0) i1 = puntos_arr.length + i1;
					if(i2 >= puntos_arr.length) i2 = i2 - puntos_arr.length;
					
					if((puntos_arr[i1].x == dragP.x && puntos_arr[i1].y == dragP.y) || (puntos_arr[i2].x == dragP.x && puntos_arr[i2].y == dragP.y)){
						puntos_arr.splice(dragP.i1, 1);	
						dibujarLineas();
						eliminar_btn.visible = false;
						eliminarPunto(dragP);				
					}
					i=puntos_arr.length+1;
				}
			}
			calcularArea();
		}
		
		function eliminarRelease(event){
			puntos_arr.splice(dragP.i1, 1);	
			dibujarLineas();
			eliminar_btn.visible = false;
			eliminarPunto(dragP);
			calcularArea();
		}
		
		function eliminarPunto(mc){
			_this.removeChild(mc);
		}
		
		eliminar_btn.addEventListener("pressup", eliminarRelease);
		
		
		//Primera goma-------------------------------------------------------
		function btnPress(event){
			var mc = event.currentTarget;	
			var offset = mc.globalToLocal(_this.getStage().mouseX, _this.getStage().mouseY);
			goma1_mc.offsetX = offset.x*escala;	
			goma1_mc.offsetY = offset.y*escala;
			goma_btn.visible = false;
			goma1_mc.visible = true;
			goma1_mc.x = _this.getStage().mouseX*escala;// + goma1_mc.offsetX;	
			goma1_mc.y = _this.getStage().mouseY*escala;// + goma1_mc.offsetY;	
		}
		
		function btnDrag(event){
			var mc = event.currentTarget;
			goma1_mc.x = _this.getStage().mouseX*escala;// + goma1_mc.offsetX;	
			goma1_mc.y = _this.getStage().mouseY*escala;// + goma1_mc.offsetY;			
			dibujarLineas();
		}
		
		function btnRelease(event){	
			
			if(goma1_mc.y < goma_btn.y-150){
				puntos_arr.push(crearPunto());
				puntos_arr.push(crearPunto());
				
				cx = goma1_mc.x;	
				cy = goma1_mc.y;	
				
				for(var i=0; i<puntos_arr.length; i++){
					puntos_arr[i].addEventListener("mousedown", press);
					puntos_arr[i].addEventListener("pressmove", drag);
					puntos_arr[i].addEventListener("pressup", release);
					puntos_arr[i].x = cx;
					puntos_arr[i].y = cy + gridDist*i - gridDist/10 + gridDist/5*i;
					snapPunto(puntos_arr[i]);
				}
					
				
				goma1_mc.visible = false;
				dibujarLineas();
			}else{
				goma_btn.visible = true;
				goma1_mc.visible = false;
			}
		}
		
		
		goma_btn.addEventListener("mousedown", btnPress);
		goma_btn.addEventListener("pressmove", btnDrag);
		goma_btn.addEventListener("pressup", btnRelease);
		
		
		
		
		function calcularArea(){
		
			//Duplicar array de punts
			var p_arr = copiarArray(puntos_arr);
			var lineas_arr = [];
			var cortes_arr = [];
			
			var auxPoints_arr = [];
			
			for(var i=0; i<p_arr.length; i++){
				p_arr[i].ind = i;
				p_arr[i].guardado = false;
			}
			
			if(p_arr.length > 3){
			
				for(var i=0; i<p_arr.length-1; i++){
					lineas_arr.push(getLinea(p_arr[i], p_arr[i+1]));
				}
				lineas_arr.push(getLinea(p_arr[i], p_arr[0]));
				
				//Detectar creuaments entre línies
				for(var i=0; i<lineas_arr.length; i++){			
					for(var j=0; j<lineas_arr.length; j++){
						if(i!=j){
							var corte = getCorteLineas(lineas_arr[i], lineas_arr[j]);
							if(corte.corte){
								cortes_arr.push(corte);
							}
						}
					}
				}
				
				//Borrar cortes repetidos
			/*	if(cortes_arr.length > 1){
					cortes_arr = cortes_arr.sort((a, b) => a.cx - b.cx);
					var c_arr = [cortes_arr[0]];
					var cx = cortes_arr[0].cx;
					var cy = cortes_arr[0].cy;
					for(var i=0; i<cortes_arr.length; i++){
						if(cortes_arr[i].cx != cx || cortes_arr[i].cy != cy){
							c_arr.push(cortes_arr[i]);
							cx = cortes_arr[i].cx;
							cy = cortes_arr[i].cy;
						}
					}
					cortes_arr = c_arr;
				}
				
				//Fer un swap entre els punts d'uns dels extrems
				for(var i=0; i<cortes_arr.length; i++){
					 //Añadir puntos en los cortes
					var corte = cortes_arr[i];
					var c1 = crearPunto();	
					var c2 = crearPunto();	
					
					auxPoints_arr.push(c1);
					auxPoints_arr.push(c2);
					
					c1.x = c2.x = corte.cx; 
					c1.y = c2.y = corte.cy;				
		
					//partir el trozo de array que hay que voltear
					var i1 = corte.line1.p1.ind;
					var i2 = corte.line2.p1.ind;
					
					for(var i=0; i<p_arr.length-1; i++){
						if(p_arr[i] == corte.line1.p1){
							p_arr.splice(i, 0, c1);
						}
					}
					
					for(var i=0; i<p_arr.length-1; i++){
						if(p_arr[i] == corte.line2.p1){
							p_arr.splice(i, 0, c2);
						}
					}
				}*/
			}
			
			//Buscar parejas de puntos	
			if(cortes_arr.length == 0){
				if(p_arr.length > 2){		
					var area = 0;
					for(var i=0; i<p_arr.length-1; i++){
						area += p_arr[i].x * p_arr[i+1].y - p_arr[i+1].x * p_arr[i].y;
					}
					area += p_arr[i].x * p_arr[0].y - p_arr[0].x * p_arr[i].y;
					
					area = numToStr(redondear(Math.abs(area/2)/10000, 2));
					
					_this.txt.text = "Àrea = " + area;
				}else{
					_this.txt.text = "Àrea =  0";
				}
			}else{
				_this.txt.text = "Els costats s'intersequen";
			}
			
			for(var i=0; i<auxPoints_arr.length; i++){
				_this.removeChild(auxPoints_arr[i]);
			}
		}
		
		
		//Selec grid*************************************************************
		var grid_arr = [this.grid1_btn, this.grid2_btn];
		var gridValues_arr = [0, gridDist/2];
		
		var resalte_mc = this.resalte_mc;
		
		var selecGrid = 0;
		
		function gridRelease(event){
			var btn = event.currentTarget;
			if(selecGrid != btn.vari){
				gridOfset = gridValues_arr[btn.vari];
				selecGrid = btn.vari;
				resalte_mc.x = btn.x;
				resalte_mc.y = btn.y;
				situarClavos();
			}
		}
		
		for(var i=0; i<grid_arr.length; i++){
			grid_arr[i].vari = i;
			grid_arr[i].addEventListener("pressup", gridRelease);
		}
		
		
		situarClavos();
	}

	// actions tween:
	this.timeline.addTween(cjs.Tween.get(this).wait(1).call(this.frame_1).wait(1));

	// Capa_1
	this.resalte_mc = new lib.resalte();
	this.resalte_mc.name = "resalte_mc";
	this.resalte_mc.parent = this;
	this.resalte_mc.setTransform(791.1,731.4);

	this.grid2_btn = new lib.btn2();
	this.grid2_btn.name = "grid2_btn";
	this.grid2_btn.parent = this;
	this.grid2_btn.setTransform(871.6,731.4,0.857,0.857);

	this.grid1_btn = new lib.btn1();
	this.grid1_btn.name = "grid1_btn";
	this.grid1_btn.parent = this;
	this.grid1_btn.setTransform(791.1,731.4,0.857,0.857);

	this.txt = new cjs.Text("Evita que el costats s'intersequin", "30px 'Franklin Gothic Demi'", "#9966CC");
	this.txt.name = "txt";
	this.txt.textAlign = "center";
	this.txt.lineHeight = 36;
	this.txt.lineWidth = 469;
	this.txt.parent = this;
	this.txt.setTransform(457,717.6);

	this.eliminar_btn = new lib.eliminar_btn();
	this.eliminar_btn.name = "eliminar_btn";
	this.eliminar_btn.parent = this;
	this.eliminar_btn.setTransform(1061.1,270.4);

	this.point_mc = new lib.point_mc();
	this.point_mc.name = "point_mc";
	this.point_mc.parent = this;
	this.point_mc.setTransform(969.5,283.5);

	this.p2 = new lib.point_mc();
	this.p2.name = "p2";
	this.p2.parent = this;
	this.p2.setTransform(1132.5,390.8);

	this.p1 = new lib.point_mc();
	this.p1.name = "p1";
	this.p1.parent = this;
	this.p1.setTransform(969.5,390.8);

	this.timeline.addTween(cjs.Tween.get({}).to({state:[{t:this.p1},{t:this.p2},{t:this.point_mc},{t:this.eliminar_btn},{t:this.txt},{t:this.grid1_btn},{t:this.grid2_btn},{t:this.resalte_mc}]}).wait(2));

	// Capa_3
	this.dumi = new lib.dumi();
	this.dumi.name = "dumi";
	this.dumi.parent = this;
	this.dumi.setTransform(913.7,765.1);

	this.goma1_mc = new lib.goma1_mc();
	this.goma1_mc.name = "goma1_mc";
	this.goma1_mc.parent = this;
	this.goma1_mc.setTransform(-87,727.1);

	this.goma_btn = new lib.goma_btn();
	this.goma_btn.name = "goma_btn";
	this.goma_btn.parent = this;
	this.goma_btn.setTransform(68.2,729.8,0.68,0.68,0,0,0,-0.2,-0.1);

	this.instance = new lib.baseUi_mc();
	this.instance.parent = this;
	this.instance.setTransform(457,766);

	this.clavo = new lib.clavo();
	this.clavo.name = "clavo";
	this.clavo.parent = this;
	this.clavo.setTransform(1014.9,283.7,1,1,0,0,0,10.3,10.3);

	this.instance_1 = new lib.blackwood();
	this.instance_1.parent = this;
	this.instance_1.setTransform(-1,-20);

	this.timeline.addTween(cjs.Tween.get({}).to({state:[{t:this.instance_1},{t:this.clavo},{t:this.instance},{t:this.goma_btn},{t:this.goma1_mc},{t:this.dumi}]}).wait(2));

}).prototype = p = new cjs.MovieClip();
p.nominalBounds = new cjs.Rectangle(358.5,363,1244.1,806);
// library properties:
lib.properties = {
	id: '8F3A19B425CD4E4CB1E48196E98C3458',
	width: 914,
	height: 766,
	fps: 25,
	color: "#FFFFFF",
	opacity: 1.00,
	manifest: [
		{src:"images/blackwood.jpg?1650586819282", id:"blackwood"},
		{src:"images/Mapadebits2.png?1650586819282", id:"Mapadebits2"}
	],
	preloads: []
};



// bootstrap callback support:

(lib.Stage = function(canvas) {
	createjs.Stage.call(this, canvas);
}).prototype = p = new createjs.Stage();

p.setAutoPlay = function(autoPlay) {
	this.tickEnabled = autoPlay;
}
p.play = function() { this.tickEnabled = true; this.getChildAt(0).gotoAndPlay(this.getTimelinePosition()) }
p.stop = function(ms) { if(ms) this.seek(ms); this.tickEnabled = false; }
p.seek = function(ms) { this.tickEnabled = true; this.getChildAt(0).gotoAndStop(lib.properties.fps * ms / 1000); }
p.getDuration = function() { return this.getChildAt(0).totalFrames / lib.properties.fps * 1000; }

p.getTimelinePosition = function() { return this.getChildAt(0).currentFrame / lib.properties.fps * 1000; }

an.bootcompsLoaded = an.bootcompsLoaded || [];
if(!an.bootstrapListeners) {
	an.bootstrapListeners=[];
}

an.bootstrapCallback=function(fnCallback) {
	an.bootstrapListeners.push(fnCallback);
	if(an.bootcompsLoaded.length > 0) {
		for(var i=0; i<an.bootcompsLoaded.length; ++i) {
			fnCallback(an.bootcompsLoaded[i]);
		}
	}
};

an.compositions = an.compositions || {};
an.compositions['8F3A19B425CD4E4CB1E48196E98C3458'] = {
	getStage: function() { return exportRoot.getStage(); },
	getLibrary: function() { return lib; },
	getSpriteSheet: function() { return ss; },
	getImages: function() { return img; }
};

an.compositionLoaded = function(id) {
	an.bootcompsLoaded.push(id);
	for(var j=0; j<an.bootstrapListeners.length; j++) {
		an.bootstrapListeners[j](id);
	}
}

an.getComposition = function(id) {
	return an.compositions[id];
}



})(createjs = createjs||{}, AdobeAn = AdobeAn||{});
var createjs, AdobeAn;